<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Blue Bear</title>
<style type="text/css">
body {
  position: relative;
}

#scoreboard {
  position: absolute;
  top: 0;
  left: 367px;
  font-family: "Courier New", Courier;
  color: #223;
}

#controls {
  position: absolute;
  top: 156px;
  left: 367px;
}
#arrows {
  text-align: center;
}

#playground {
  border: 1px solid #445;
  border-radius: 7px;
  background-color: #bcf;
}

#help {
  display: none;
}
</style>
</head>
<body>

<div id="playground"></div>
<div id="scoreboard">
 <label id="score">Score: <span></span></label><br/>
 <label id="level">Level: <span></span></label>
</div>
<div id="controls">
 <div id="arrows">
  <button id="arrowUp">&uarr;</button><br/>
  <button id="arrowLeft">&larr;</button>
  &nbsp;&nbsp;&nbsp;&nbsp;
  <button id="arrowRight">&rarr;</button><br/>
  <button id="arrowDown">&darr;</button>
 </div>
</div>
<div id="help">
 <p>Use arrow keys (left, right, up, down) to move</p>
 <p>Use spacebar to attack</p>
 <p>Press escape to pause</p>
</div>

<script type="text/javascript" src="res/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="res/jquery.gamequery-0.6.2.js"></script>
<script type="text/javascript">
KEY_SPACE =  0;
KEY_ENTER = 13;
KEY_ESC   = 27;
KEY_LEFT  = 37;
KEY_UP    = 38;
KEY_RIGHT = 39;
KEY_DOWN  = 40;

SPRITE_WIDTH  = 24;
SPRITE_HEIGHT = 32;

TILE_WIDTH  = 44;
TILE_HEIGHT = 33;

PLAYGROUND_WIDTH = 352;
PLAYGROUND_HEIGHT = 264;

REFRESH_RATE = 30;

var playing, score, level, animations = [];

function setupAnimations() {
  var playerOpts = {
    imageURL: "res/player_basic.png",
    numberOfFrame: 3,
    delta: SPRITE_WIDTH,
    rate: 133,
    type: $.gameQuery.ANIMATION_HORIZONTAL,
  };
  var playerStoppedOpts = {
    imageURL: "res/player_basic.png",
    numberOfFrame: 1,
    delta: SPRITE_WIDTH,
    rate: 0,
    type: $.gameQuery.ANIMATION_ONCE,
    offsetx: SPRITE_WIDTH,
  };

  playerOpts.offsety = SPRITE_HEIGHT * 3;
  animations["playerLeft"] = new $.gameQuery.Animation(playerOpts);
  playerStoppedOpts.offsety = SPRITE_HEIGHT * 3;
  animations["playerStoppedLeft"] = new $.gameQuery.Animation(playerStoppedOpts);

  playerOpts.offsety = 0;
  animations["playerUp"] = new $.gameQuery.Animation(playerOpts);
  playerStoppedOpts.offsety = 0;
  animations["playerStoppedUp"] = new $.gameQuery.Animation(playerStoppedOpts);

  playerOpts.offsety = SPRITE_HEIGHT;
  animations["playerRight"] = new $.gameQuery.Animation(playerOpts);
  playerStoppedOpts.offsety = SPRITE_HEIGHT;
  animations["playerStoppedRight"] = new $.gameQuery.Animation(playerStoppedOpts);

  playerOpts.offsety = SPRITE_HEIGHT * 2;
  animations["playerDown"] = new $.gameQuery.Animation(playerOpts);
  playerStoppedOpts.offsety = SPRITE_HEIGHT * 2;
  animations["playerStoppedDown"] = new $.gameQuery.Animation(playerStoppedOpts);

// Generated with gQ's Tiles map editor
animations[0] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       0,
    offsety:       0
});
animations[1] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       44,
    offsety:       0
});
animations[2] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       88,
    offsety:       0
});
animations[3] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       132,
    offsety:       0
});
animations[4] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       176,
    offsety:       0
});
animations[5] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       220,
    offsety:       0
});
animations[6] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       264,
    offsety:       0
});
animations[7] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       308,
    offsety:       0
});
}

function setupLayers() {
// Generated with gQ's Tiles map editor
var map = [[4, 4, 4, 6, 6, 6, 6, 6, 6, 6],
           [1, 3, 3, 7, 5, 5, 5, 7, 7, 7],
           [2, 8, 8, 1, 7, 7, 7, 1, 2, 1],
           [1, 2, 1, 2, 1, 2, 1, 2, 1, 2],
           [2, 1, 2, 1, 2, 1, 2, 1, 2, 1],
           [1, 2, 1, 2, 1, 2, 1, 2, 1, 2],
           [2, 1, 2, 1, 2, 1, 2, 1, 2, 1],
           [1, 2, 1, 2, 1, 2, 1, 2, 1, 2]];

  $.playground()
    .addGroup("main", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT})
      .addGroup("background", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT})
        .addTilemap("tilemap", map,  animations, {width: 44, height: 33, sizex: 10, sizey: 8}).end().end()
      .addSprite("player", {
        animation: animations["playerStoppedRight"],
        posx: SPRITE_WIDTH * 3,
        posy: (PLAYGROUND_HEIGHT - SPRITE_HEIGHT) / 2,
        width: SPRITE_WIDTH,
        height: SPRITE_HEIGHT});
}

function updateScoreboard() {
  $("#score span").text(score);
  $("#level span").text(level);
}

function Player(node) {
  this.node = node;
  this.moved = false;

  this.update = function () {
    var x = this.node.x();
    var y = this.node.y();

    if (jQuery.gameQuery.keyTracker[KEY_LEFT] && (x-4) > 0) {
      this.node.x(-4, true);
      this.moved = true;
    }
    if (jQuery.gameQuery.keyTracker[KEY_UP] && (y-3) > 0) {
      this.node.y(-3, true);
      this.moved = true;
    }
    if (jQuery.gameQuery.keyTracker[KEY_RIGHT] && ((x+4) < (PLAYGROUND_WIDTH-SPRITE_WIDTH))) {
      this.node.x(4, true);
      this.moved = true;
    }
    if (jQuery.gameQuery.keyTracker[KEY_DOWN] && ((y+3) < (PLAYGROUND_HEIGHT-SPRITE_HEIGHT))) {
      this.node.y(3, true);
      this.moved = true;
    }
  };
}

function Background(node) {
  this.node = node;

  this.update = function (player) {
    if (player.moved) {
      this.node.x(-1, true);
      player.node.x(-1, true);
    }
  };
}

$(function () {
  $("#playground").playground({width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT, keyTracker: true});

  setupAnimations();
  setupLayers();

  $(document).keydown(function (e) {
    switch (e.which) {
      case KEY_LEFT:  $("#player").setAnimation(animations["playerLeft"]);  break;
      case KEY_UP:    $("#player").setAnimation(animations["playerUp"]);    break;
      case KEY_RIGHT: $("#player").setAnimation(animations["playerRight"]); break;
      case KEY_DOWN:  $("#player").setAnimation(animations["playerDown"]);  break;
    }
  });
  $("#arrows button").click(function (e) {
    var kde = $.Event("keydown");
    switch (this.id) {
      // NB: ---------------------------------> gameTracker not checking 'which' on keydown events
      case 'arrowLeft':  kde.which = KEY_LEFT;  kde.keyCode = KEY_LEFT;  break;
      case 'arrowUp':    kde.which = KEY_UP;    kde.keyCode = KEY_UP;    break;
      case 'arrowRight': kde.which = KEY_RIGHT; kde.keyCode = KEY_RIGHT; break;
      case 'arrowDown':  kde.which = KEY_DOWN;  kde.keyCode = KEY_DOWN;  break;
    }
    $(document).trigger(kde);
    return false;
  });
  $(document).keyup(function (e) {
    switch (e.which) {
      case KEY_LEFT:  $("#player").setAnimation(animations["playerStoppedLeft"]);  break;
      case KEY_UP:    $("#player").setAnimation(animations["playerStoppedUp"]);    break;
      case KEY_RIGHT: $("#player").setAnimation(animations["playerStoppedRight"]); break;
      case KEY_DOWN:  $("#player").setAnimation(animations["playerStoppedDown"]);  break;
    }
  });

  score = 0;
  level = 1;
  playing = true;

  $.playground().startGame(function () {
    window.focus();
    updateScoreboard();

    $("#player")[0].player = new Player($("#player"));
    $("#background")[0].background = new Background($("#background"));

    $.playground().registerCallback(function () {
      if (playing) {
        var p = $("#player")[0].player;
        p.update();
        $("#background")[0].background.update(p);
      }
    }, REFRESH_RATE);
  });
});
</script>
</body>
</html>

