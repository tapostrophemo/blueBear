<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Blue Bear</title>
<link href='http://fonts.googleapis.com/css?family=Permanent+Marker' rel='stylesheet' type='text/css'>
<style type="text/css">
body {
  position: relative;
}

#scoreboard {
  position: absolute;
  top: 0;
  left: 367px;
  font-family: monospace;
  color: #223;
}

#controls {
  position: absolute;
  top: 156px;
  left: 367px;
}
#arrows {
  text-align: center;
}

#playground {
  border: 1px solid #445;
  border-radius: 7px;
  background-color: #bcf;
}

.statusOverlay {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 1000;
  text-align: center;
  font-family: "Permanent Marker", cursive;
  font-size: 48px;
  line-height: 75px;
  width: 352px;
  height: 184px;
  padding-top: 80px;
  vertical-align: middle;
  color: white;
  background-color: rgba(0, 0, 0, 0.75);
}
.statusOverlay span {
  display: block;
  font-family: monospace;
  font-size: 15px;
}
.statusOverlay a {
  color: white;
  text-decoration: none;
}
.statusOverlay a:hover {
  text-decoration: underline;
}

#lose {
  height: 224px;
  padding-top: 40px;
}

.hidden {
  display: none;
}

#help {
  position: absolute;
  top: 275px;
  font-family: monospace;
}
</style>
</head>
<body>

<div id="playground">
 <div id="start" class="statusOverlay">START<span>(press any arrow key to begin)</span></div>
 <div id="paused" class="statusOverlay hidden">PAUSED<span>(press ESC to continue)</span></div>
 <div id="win" class="statusOverlay hidden">WINNER!<span>(<a href="level2.html">click for next level</a>)</span></div>
 <div id="lose" class="statusOverlay hidden">YOU LOST...<br/>SORRY&nbsp;&nbsp;&nbsp;:(<span>(<a href="#" onclick="window.location.reload()">click to try again</a>)</span></div>
</div>
<div id="scoreboard">
 <label id="score">Score: <span></span></label><br/>
 <label id="level">Level: <span></span></label>
</div>
<div id="controls">
 <div id="arrows">
  <button id="arrowUp">&uarr;</button><br/>
  <button id="arrowLeft">&larr;</button>
  &nbsp;&nbsp;&nbsp;&nbsp;
  <button id="arrowRight">&rarr;</button><br/>
  <button id="arrowDown">&darr;</button>
 </div>
</div>
<div id="help">
 <p>Use arrow keys (left, right, up, down) to move</p>
 <p>Press escape to pause</p>
</div>

<script type="text/javascript" src="res/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="res/jquery.gamequery-0.6.2.js"></script>
<script type="text/javascript">
KEY_SPACE =  0;
KEY_ENTER = 13;
KEY_ESC   = 27;
KEY_LEFT  = 37;
KEY_UP    = 38;
KEY_RIGHT = 39;
KEY_DOWN  = 40;

SPRITE_WIDTH  = 24;
SPRITE_HEIGHT = 24;

TILE_WIDTH  = 44;
TILE_HEIGHT = 33;

PLAYGROUND_WIDTH = 352;
PLAYGROUND_HEIGHT = 264;

REFRESH_RATE = 30;

var playing, started, paused, score, level, animations = [];

function setupPlayground() {
  $("#playground").playground({width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT, keyTracker: true});
}

function setupAnimations() {
  var playerOpts = {
    imageURL: "res/player_basic.png",
    numberOfFrame: 3,
    delta: SPRITE_WIDTH,
    rate: 133,
    type: $.gameQuery.ANIMATION_HORIZONTAL,
  };
  var playerStoppedOpts = {
    imageURL: "res/player_basic.png",
    numberOfFrame: 1,
    delta: 0,
    rate: 0,
    type: $.gameQuery.ANIMATION_ONCE,
    offsetx: SPRITE_WIDTH,
  };

  playerOpts.offsety = SPRITE_HEIGHT * 3;
  animations["playerLeft"] = new $.gameQuery.Animation(playerOpts);
  playerStoppedOpts.offsety = SPRITE_HEIGHT * 3;
  animations["playerStoppedLeft"] = new $.gameQuery.Animation(playerStoppedOpts);

  playerOpts.offsety = 0;
  animations["playerUp"] = new $.gameQuery.Animation(playerOpts);
  playerStoppedOpts.offsety = 0;
  animations["playerStoppedUp"] = new $.gameQuery.Animation(playerStoppedOpts);

  playerOpts.offsety = SPRITE_HEIGHT;
  animations["playerRight"] = new $.gameQuery.Animation(playerOpts);
  playerStoppedOpts.offsety = SPRITE_HEIGHT;
  animations["playerStoppedRight"] = new $.gameQuery.Animation(playerStoppedOpts);

  playerOpts.offsety = SPRITE_HEIGHT * 2;
  animations["playerDown"] = new $.gameQuery.Animation(playerOpts);
  playerStoppedOpts.offsety = SPRITE_HEIGHT * 2;
  animations["playerStoppedDown"] = new $.gameQuery.Animation(playerStoppedOpts);

  animations["honeypot"] = new $.gameQuery.Animation({
    imageURL: "res/honeypot.png",
    numberOfFrame: 1,
    delta: 0,
    rate: 0,
    offsetx: 0,
    offsety: 0,
    type: $.gameQuery.ANIMATION_ONCE});

  animations["bush"] = new $.gameQuery.Animation({
    imageURL: "res/bush.png",
    numberOfFrame: 1,
    delta: 0,
    rate: 0,
    offsetx: 0,
    offsety: 0,
    type: $.gameQuery.ANIMATION_ONCE});

  animations["finishLine"] = new $.gameQuery.Animation({
    imageURL: "res/finish_line.png",
    numberOfFrame: 2,
    delta: 11,
    rate: 175,
    offsetx: 0,
    offsety: 0,
    type: $.gameQuery.ANIMATION_HORIZONTAL});

// Generated with gQ's Tiles map editor
animations[0] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       0,
    offsety:       0
});
animations[1] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       44,
    offsety:       0
});
animations[2] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       88,
    offsety:       0
});
animations[3] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       132,
    offsety:       0
});
animations[4] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       176,
    offsety:       0
});
animations[5] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       220,
    offsety:       0
});
animations[6] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       264,
    offsety:       0
});
animations[7] =  new $.gameQuery.Animation({
    imageURL:      'res/ground_basic.png',
    type:          $.gameQuery.ANIMATION_HORIZONTAL,
    numberOfFrame: 1,
    delta:         0,
    rate:          0,
    offsetx:       308,
    offsety:       0
});
}

function setupLayers() {
// Generated with gQ's Tiles map editor
var map = [[2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1],
           [1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2],
           [2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1],
           [1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2],
           [2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1],
           [1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2],
           [2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1],
           [1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2]];

  var honeypots = 1, bushes = 1;
  $.playground()
    .addGroup("main", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT})
      .addGroup("background", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT})
        .addTilemap('tilemap', map,  animations, {width: 44, height: 33, sizex: 18, sizey: 8}).end().end()
      .addSprite("finishLine", {
        animation: animations["finishLine"],
        posx: $("#tilemap").width()-TILE_WIDTH,
        posy: 0,
        width: TILE_WIDTH,
        height: PLAYGROUND_HEIGHT})
      .addSprite("player", {
        animation: animations["playerStoppedRight"],
        posx: SPRITE_WIDTH * 3,
        posy: (PLAYGROUND_HEIGHT - SPRITE_HEIGHT) / 2,
        width: SPRITE_WIDTH,
        height: SPRITE_HEIGHT})
      .addGroup("obstacles", {width: $("#tilemap").width(), height: PLAYGROUND_HEIGHT})
        .addSprite("bush_"+bushes++, {
          animation: animations["bush"],
          posx: TILE_WIDTH * 3 + 30/2,
          posy: TILE_HEIGHT * 3 + 30/2,
          width: 30,
          height: 30})
        .addSprite("bush_"+bushes++, {
          animation: animations["bush"],
          posx: TILE_WIDTH * 8 + 30/2,
          posy: TILE_HEIGHT * 6 + 30/2,
          width: 30,
          height: 30})
        .addSprite("bush_"+bushes++, {
          animation: animations["bush"],
          posx: TILE_WIDTH * 12 + 30/2,
          posy: TILE_HEIGHT * 4 + 30/2,
          width: 30,
          height: 30})
        .addSprite("bush_"+bushes++, {
          animation: animations["bush"],
          posx: TILE_WIDTH * 16 + 30/2,
          posy: TILE_HEIGHT * 8 + 30/2,
          width: 30,
          height: 30}).end()
      .addGroup("rewards", {width: PLAYGROUND_WIDTH, height: PLAYGROUND_HEIGHT})
        .addSprite("honeypot_"+honeypots++, {
          animation: animations["honeypot"],
          posx: TILE_WIDTH * 4 + 18/2,
          posy: TILE_HEIGHT * 4 + 14/2,
          width: 22,
          height: 15})
        .addSprite("honeypot_"+honeypots++, {
          animation: animations["honeypot"],
          posx: TILE_WIDTH * 7 + 18/2,
          posy: TILE_HEIGHT * 2 + 14/2,
          width: 22,
          height: 15})
        .addSprite("honeypot_"+honeypots++, {
          animation: animations["honeypot"],
          posx: TILE_WIDTH * 9 + 18/2,
          posy: TILE_HEIGHT * 4 + 14/2,
          width: 22,
          height: 15})
        .addSprite("honeypot_"+honeypots++, {
          animation: animations["honeypot"],
          posx: TILE_WIDTH * 12 + 18/2,
          posy: TILE_HEIGHT * 7 + 14/2,
          width: 22,
          height: 15})
        .addSprite("honeypot_"+honeypots++, {
          animation: animations["honeypot"],
          posx: TILE_WIDTH * 14 + 18/2,
          posy: TILE_HEIGHT * 0 + 14/2,
          width: 22,
          height: 15})
        .addSprite("honeypot_"+honeypots++, {
          animation: animations["honeypot"],
          posx: TILE_WIDTH * 15 + 18/2,
          posy: TILE_HEIGHT * 3 + 14/2,
          width: 22,
          height: 15}).end();
}

function updateScoreboard() {
  $("#score span").text(score);
  $("#level span").text(level);
}

function isArrowKey(event) {
  return event.which == KEY_LEFT  ||
         event.which == KEY_UP    ||
         event.which == KEY_RIGHT ||
         event.which == KEY_DOWN;
}

function Player(node) {
  this.node = node;
  this.moved = false;

  this.update = function () {
    var x = this.node.x();
    var y = this.node.y();

    if ($.gameQuery.keyTracker[KEY_LEFT] && (x-4) > 0) {
      this.node.x(-4, true);
      this.moved = true;
    }
    if ($.gameQuery.keyTracker[KEY_UP] && (y-3) > 0) {
      this.node.y(-3, true);
      this.moved = true;
    }
    if ($.gameQuery.keyTracker[KEY_RIGHT] && ((x+4) < (PLAYGROUND_WIDTH-SPRITE_WIDTH))) {
      this.node.x(4, true);
      this.moved = true;
    }
    if ($.gameQuery.keyTracker[KEY_DOWN] && ((y+3) < (PLAYGROUND_HEIGHT-SPRITE_HEIGHT))) {
      this.node.y(3, true);
      this.moved = true;
    }
  };

  this.bumpBack = function () {
    var x = this.node.x();
    var y = this.node.y();

    if ($.gameQuery.keyTracker[KEY_LEFT]) {
      this.node.x(4, true);
    }
    if ($.gameQuery.keyTracker[KEY_UP]) {
      this.node.y(3, true);
    }
    if ($.gameQuery.keyTracker[KEY_RIGHT]) {
      this.node.x(-4, true);
    }
    if ($.gameQuery.keyTracker[KEY_DOWN]) {
      this.node.y(-3, true);
    }
  };

  this.offScreen = function () {
    return this.node.x() <= (-1*SPRITE_WIDTH*0.6);
  };
}

function Rewards(node) {
  this.node = node;

  this.update = function (player, finishLine) {
    if (player.moved && !finishLine.completelyShowing()) {
      this.node.x(-1, true);
    }
    checkCollisions(player);
  };

  function checkCollisions(player) {
    player.node.collision(".group,.reward").each(function () {
      $(this).remove();
      score++;
      updateScoreboard();
    });
  }
}

function Obstacles(node) {
  this.node = node;

  this.update = function (player, finishLine) {
    if (player.moved && !finishLine.completelyShowing()) {
      this.node.x(-1, true);
    }
    checkCollisions(player);
  }

  function checkCollisions(player) {
    player.node.collision(".group,.obstacle").each(function () {
      player.bumpBack();
    });
  }
}

function FinishLine(node) {
  this.node = node;

  this.update = function (player) {
    if (player.moved && !this.completelyShowing()) {
      this.node.x(-1, true);
    }
  };

  this.crossedBy = function (player) {
    return player.node.x() > this.node.x();
  };

  this.completelyShowing = function () {
    return this.node.x() <= (PLAYGROUND_WIDTH - this.node.width());
  };
}

function Background(node) {
  this.node = node;

  this.update = function (player, finishLine) {
    if (player.moved && !finishLine.completelyShowing()) {
      this.node.x(-1, true);
      player.node.x(-1, true);
    }
  };
}

$(function () {
  score = 0;
  level = 1;
  started = false;
  playing = true;
  paused = false;

  setupPlayground();
  setupAnimations();
  setupLayers();

  var player = $("#player")[0].player = new Player($("#player"));
  var $player = player.node;

  $(document).keydown(function (e) {
    if (!started && e.which == KEY_ESC) {
      return;
    }

    if (!started && isArrowKey(e)) {
      $("#start").fadeOut(REFRESH_RATE * 2);
      started = true;
    }

    switch (e.which) {
      case KEY_LEFT:  $player.setAnimation(animations["playerLeft"]);  break;
      case KEY_UP:    $player.setAnimation(animations["playerUp"]);    break;
      case KEY_RIGHT: $player.setAnimation(animations["playerRight"]); break;
      case KEY_DOWN:  $player.setAnimation(animations["playerDown"]);  break;
      case KEY_ESC:
        paused = !paused;
        if (paused) {
          $("#paused").fadeIn(REFRESH_RATE * 3);
        } else {
          $("#paused").fadeOut(REFRESH_RATE);
        }
        break;
    }
  });
  $("#arrows button").click(function (e) {
    var kde = $.Event("keydown");
    switch (this.id) {
      // NB: ---------------------------------> gameTracker not checking 'which' on keydown events
      case 'arrowLeft':  kde.which = KEY_LEFT;  kde.keyCode = KEY_LEFT;  break;
      case 'arrowUp':    kde.which = KEY_UP;    kde.keyCode = KEY_UP;    break;
      case 'arrowRight': kde.which = KEY_RIGHT; kde.keyCode = KEY_RIGHT; break;
      case 'arrowDown':  kde.which = KEY_DOWN;  kde.keyCode = KEY_DOWN;  break;
    }
    $(document).trigger(kde);
    return false;
  });
  $(document).keyup(function (e) {
    switch (e.which) {
      case KEY_LEFT:  $player.setAnimation(animations["playerStoppedLeft"]);  break;
      case KEY_UP:    $player.setAnimation(animations["playerStoppedUp"]);    break;
      case KEY_RIGHT: $player.setAnimation(animations["playerStoppedRight"]); break;
      case KEY_DOWN:  $player.setAnimation(animations["playerStoppedDown"]);  break;
    }
  });

  $.playground().startGame(function () {
    var i;

    window.focus();
    updateScoreboard();

    var background = $("#background")[0].background = new Background($("#background"));
    var finishLine = $("#finishLine")[0].finishLine = new FinishLine($("#finishLine"));
    var rewards = $("#rewards")[0].rewards = new Rewards($("#rewards"));
    for (i = 1; i <= 6; i++) {
      var h = $("#honeypot_"+i);
      h.addClass("reward");
    }
    var obstacles = $("#obstacles")[0].obstacles = new Obstacles($("#obstacles"));
    for (i = 1; i <= 4; i++) {
      var b = $("#bush_"+i);
      b.addClass("obstacle");
    }

    $.playground().registerCallback(function () {
      if (playing && !paused) {
        player.update();

        background.update(player, finishLine);
        rewards.update(player, finishLine);
        obstacles.update(player, finishLine);
        finishLine.update(player);

        if (player.offScreen()) {
          $("#lose").fadeIn(REFRESH_RATE * 8);
          $(document).unbind("keydown");
          $(document).unbind("keyup");
          return true;
        }

        if (finishLine.crossedBy(player)) {
          $("#win").fadeIn(REFRESH_RATE * 4);
          $(document).unbind("keydown");
          $(document).unbind("keyup");
          return true;
        }
      }
    }, REFRESH_RATE);
  });
});
</script>
</body>
</html>

